// Auto-generated by XekuII.Generator - DO NOT EDIT
// Generated at: 2026-02-06 22:03:33

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useNavigate, useParams } from "@tanstack/react-router";
import { useEffect } from "react";
import { purchaseOrderItemApi } from "../../api/purchase-order-item.api.generated";
import { createPurchaseOrderItemSchema } from "../../schemas/purchase-order-item.schema.generated";
import type { CreatePurchaseOrderItemDto } from "../../types/purchase-order-item.types.generated";
import { EntityForm, type FieldConfig, type FormRowConfig } from "@/components/shared/EntityForm";
import { ReferenceSelect } from "@/components/shared/ReferenceSelect";
import { PageLoading } from "@/components/shared/LoadingSpinner";
import { toast } from "sonner";
import { useEntityPermissions } from "@/hooks/usePermissions";

const fieldConfigs: FieldConfig[] = [
  { name: "quantity", label: "數量", type: "number" as const },
  { name: "unitPrice", label: "進貨單價", type: "number" as const },
  {
    name: "purchaseOrderId",
    label: "採購單",
    type: "custom" as const,
    render: ({ value, onChange }) => (
      <ReferenceSelect
        endpoint="/purchase-orders"
        value={value as string | null}
        onChange={onChange as (v: string | null) => void}
        labelField="name"
        placeholder="Select 採購單..."
      />
    ),
  },
  {
    name: "productId",
    label: "採購產品",
    type: "custom" as const,
    render: ({ value, onChange }) => (
      <ReferenceSelect
        endpoint="/products"
        value={value as string | null}
        onChange={onChange as (v: string | null) => void}
        labelField="name"
        placeholder="Select 採購產品..."
      />
    ),
  },
];

const formLayout: FormRowConfig[] = [
  { fields: ["productId"] },
  { fields: ["quantity", "unitPrice"] },
  { fields: ["subtotal"] },
];

export function PurchaseOrderItemFormPage() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const params = useParams({ strict: false });
  const id = (params as Record<string, string | undefined>).id;
  const isEdit = !!id;
  const { canCreate, canUpdate, loaded: permissionsLoaded } = useEntityPermissions("PurchaseOrderItem");

  const { data: existing, isLoading } = useQuery({
    queryKey: ["purchaseOrderItem", id],
    queryFn: () => purchaseOrderItemApi.getById(id!),
    enabled: isEdit,
  });

  const createMutation = useMutation({
    mutationFn: (data: CreatePurchaseOrderItemDto) => purchaseOrderItemApi.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["purchaseOrderItems"] });
      toast.success("採購明細 created");
      navigate({ to: "/purchase-order-items" });
      },
    onError: () => toast.error("Failed to create 採購明細"),
  });

  const updateMutation = useMutation({
    mutationFn: (data: CreatePurchaseOrderItemDto) => purchaseOrderItemApi.update(id!, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["purchaseOrderItems"] });
      queryClient.invalidateQueries({ queryKey: ["purchaseOrderItem", id] });
      toast.success("採購明細 updated");
      navigate({ to: "/purchase-order-items" });
      },
    onError: () => toast.error("Failed to update 採購明細"),
  });

  useEffect(() => {
    if (!permissionsLoaded) return;
    if ((!isEdit && !canCreate) || (isEdit && !canUpdate)) {
      toast.error("You don't have permission to perform this action");
      navigate({ to: "/purchase-order-items" });
    }
  }, [isEdit, canCreate, canUpdate, permissionsLoaded, navigate]);

  if (isEdit && isLoading) return <PageLoading />;

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const ex = existing as any;
  const defaultValues = isEdit && ex
    ? {
      quantity: ex.quantity ?? 1,
      unitPrice: ex.unitPrice ?? 0,
      purchaseOrderId: ex.purchaseOrderId ?? null,
      productId: ex.productId ?? null,
    }
    : {
      quantity: 1,
      unitPrice: 0,
      purchaseOrderId: null,
      productId: null,
    };

  return (
    <div className="max-w-2xl space-y-4">
      <h1 className="text-2xl font-bold">{isEdit ? "Edit" : "New"} 採購明細</h1>
      <EntityForm
        schema={createPurchaseOrderItemSchema}
        defaultValues={defaultValues}
        fields={fieldConfigs}
        layout={formLayout}
        onSubmit={(data) => isEdit ? updateMutation.mutate(data as CreatePurchaseOrderItemDto) : createMutation.mutate(data as CreatePurchaseOrderItemDto)}
        loading={createMutation.isPending || updateMutation.isPending}
        submitLabel={isEdit ? "Update" : "Create"}
        onCancel={() => navigate({ to: "/purchase-order-items" })}
      />
    </div>
  );
}

