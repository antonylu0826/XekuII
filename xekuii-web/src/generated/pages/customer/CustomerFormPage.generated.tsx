// Auto-generated by XekuII.Generator - DO NOT EDIT
// Generated at: 2026-02-06 15:32:06

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useNavigate, useParams } from "@tanstack/react-router";
import { customerApi } from "../../api/customer.api.generated";
import { createCustomerSchema } from "../../schemas/customer.schema.generated";
import type { CreateCustomerDto } from "../../types/customer.types.generated";
import { EntityForm, type FieldConfig, type FormRowConfig } from "@/components/shared/EntityForm";
import { PageLoading } from "@/components/shared/LoadingSpinner";
import { toast } from "sonner";

const fieldConfigs: FieldConfig[] = [
  { name: "code", label: "客戶代號", type: "text" as const },
  { name: "name", label: "客戶姓名", type: "text" as const },
  { name: "email", label: "電子郵件", type: "text" as const },
  { name: "phone", label: "電話", type: "text" as const },
];

const formLayout: FormRowConfig[] = [
  { fields: ["code", "name"] },
  { fields: ["email", "phone"] },
];

export function CustomerFormPage() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const params = useParams({ strict: false });
  const id = (params as Record<string, string | undefined>).id;
  const isEdit = !!id;

  const { data: existing, isLoading } = useQuery({
    queryKey: ["customer", id],
    queryFn: () => customerApi.getById(id!),
    enabled: isEdit,
  });

  const createMutation = useMutation({
    mutationFn: (data: CreateCustomerDto) => customerApi.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["customers"] });
      toast.success("客戶 created");
      navigate({ to: "/customers" });
    },
    onError: () => toast.error("Failed to create 客戶"),
  });

  const updateMutation = useMutation({
    mutationFn: (data: CreateCustomerDto) => customerApi.update(id!, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["customers"] });
      queryClient.invalidateQueries({ queryKey: ["customer", id] });
      toast.success("客戶 updated");
      navigate({ to: "/customers" });
    },
    onError: () => toast.error("Failed to update 客戶"),
  });

  if (isEdit && isLoading) return <PageLoading />;

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const ex = existing as any;
  const defaultValues = isEdit && ex
    ? {
      code: ex.code ?? "",
      name: ex.name ?? "",
      email: ex.email ?? "",
      phone: ex.phone ?? "",
    }
    : {
      code: "",
      name: "",
      email: "",
      phone: "",
    };

  return (
    <div className="max-w-2xl space-y-4">
      <h1 className="text-2xl font-bold">{isEdit ? "Edit" : "New"} 客戶</h1>
      <EntityForm
        schema={createCustomerSchema}
        defaultValues={defaultValues}
        fields={fieldConfigs}
        layout={formLayout}
        onSubmit={(data) => isEdit ? updateMutation.mutate(data as CreateCustomerDto) : createMutation.mutate(data as CreateCustomerDto)}
        loading={createMutation.isPending || updateMutation.isPending}
        submitLabel={isEdit ? "Update" : "Create"}
        onCancel={() => navigate({ to: "/customers" })}
      />
    </div>
  );
}

