// Auto-generated by XekuII.Generator - DO NOT EDIT
// Generated at: 2026-02-06 15:32:06

import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useNavigate, useParams } from "@tanstack/react-router";
import { useState, useEffect } from "react";
import { orderApi } from "../../api/order.api.generated";
import { createOrderSchema } from "../../schemas/order.schema.generated";
import type { CreateOrderDto } from "../../types/order.types.generated";
import type { OrderItemSummary, CreateOrderItemItemDto } from "../../types/order.types.generated";
import { createOrderItemItemSchema } from "../../schemas/order.schema.generated";
import { InlineDetailTable, type InlineDetailItem, type InlineDetailColumn } from "@/components/shared/InlineDetailTable";
import { EntityForm, type FieldConfig } from "@/components/shared/EntityForm";
import { ReferenceSelect } from "@/components/shared/ReferenceSelect";
import { PageLoading } from "@/components/shared/LoadingSpinner";
import { toast } from "sonner";

const fieldConfigs: FieldConfig[] = [
  { name: "orderNo", label: "訂單單號", type: "text" as const },
  { name: "orderDate", label: "訂單日期", type: "date" as const },
  {
    name: "customerId",
    label: "客戶",
    type: "custom" as const,
    render: ({ value, onChange }) => (
      <ReferenceSelect
        endpoint="/customers"
        value={value as string | null}
        onChange={onChange as (v: string | null) => void}
        labelField="name"
        placeholder="Select 客戶..."
      />
    ),
  },
];

const orderItemFieldConfigs: FieldConfig[] = [
  { name: "quantity", label: "數量", type: "number" as const },
  { name: "price", label: "單價", type: "number" as const },
  {
    name: "productId",
    label: "產品",
    type: "custom" as const,
    render: ({ value, onChange }, { setValue }) => (
      <ReferenceSelect
        endpoint="/products"
        value={value as string | null}
        onChange={onChange as (v: string | null) => void}
        onLabelChange={(label) => setValue("productName", label)}
        labelField="name"
        placeholder="Select 產品..."
      />
    ),
  },
];

const orderItemColumns: InlineDetailColumn[] = [
  { key: "quantity", header: "數量" },
  { key: "price", header: "單價" },
  { key: "lineTotal", header: "小計" },
  { key: "productName", header: "產品" },
];

const orderItemDefaults: Record<string, unknown> = {
  quantity: 1,
  price: 0,
  productId: null,
};

export function OrderFormPage() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const params = useParams({ strict: false });
  const id = (params as Record<string, string | undefined>).id;
  const isEdit = !!id;
  const [saving, setSaving] = useState(false);

  const [orderItemItems, setOrderItemItems] = useState<InlineDetailItem[]>([]);
  const [detailsLoaded, setDetailsLoaded] = useState(false);

  const { data: existing, isLoading } = useQuery({
    queryKey: ["order", id],
    queryFn: () => orderApi.getById(id!),
    enabled: isEdit,
  });

  // Load detail items for edit mode
  useEffect(() => {
    if (!isEdit || !id || detailsLoaded) return;
    orderApi.getDetails(id).then((data) => {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const d = data as any;
      setOrderItemItems((d.items || []).map((item: any) => ({
        ...item,
        _localId: crypto.randomUUID(),
        _status: "existing" as const,
        _serverId: item.oid ?? item.id,
      })));
      setDetailsLoaded(true);
    });
  }, [isEdit, id, detailsLoaded]);

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  async function handleSubmit(masterData: any) {
    setSaving(true);
    try {
      let masterId: string;
      if (isEdit) {
        await orderApi.update(id!, masterData as CreateOrderDto);
        masterId = id!;
      } else {
        const result = await orderApi.create(masterData as CreateOrderDto);
        masterId = result.oid;
      }

      const failures: string[] = [];

      // Process Items
      for (const item of orderItemItems.filter(i => i._status === "deleted" && i._serverId)) {
        try { await orderApi.deleteOrderItem(masterId, item._serverId!); }
        catch { failures.push(`Delete 訂單明細 ${item._serverId}`); }
      }
      for (const item of orderItemItems.filter(i => i._status === "modified" && i._serverId)) {
        try {
          const dto = { ...item } as any;
          delete dto._localId; delete dto._status; delete dto._serverId; delete dto.id;
          await orderApi.updateOrderItem(masterId, item._serverId!, dto);
        } catch { failures.push(`Update 訂單明細`); }
      }
      for (const item of orderItemItems.filter(i => i._status === "new")) {
        try {
          const dto = { ...item } as any;
          delete dto._localId; delete dto._status; delete dto._serverId;
          await orderApi.addOrderItem(masterId, dto as CreateOrderItemItemDto);
        } catch { failures.push(`Add 訂單明細`); }
      }

      queryClient.invalidateQueries({ queryKey: ["orders"] });
      queryClient.invalidateQueries({ queryKey: ["order", masterId] });

      if (failures.length > 0) {
        toast.warning(`訂單 saved, but ${failures.length} detail items failed`);
        navigate({ to: "/orders/$id", params: { id: masterId } });
      } else {
        toast.success(isEdit ? "訂單 updated" : "訂單 created");
        navigate({ to: "/orders" });
      }
    } catch {
      toast.error("Failed to save 訂單");
    } finally {
      setSaving(false);
    }
  }

  if (isEdit && isLoading) return <PageLoading />;

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const ex = existing as any;
  const defaultValues = isEdit && ex
    ? {
      orderNo: ex.orderNo ?? "NEW",
      orderDate: ex.orderDate ?? new Date().toISOString().split('T')[0],
      customerId: ex.customerId ?? null,
    }
    : {
      orderNo: "NEW",
      orderDate: new Date().toISOString().split('T')[0],
      customerId: null,
    };

  return (
    <div className="max-w-5xl space-y-4">
      <h1 className="text-2xl font-bold">{isEdit ? "Edit" : "New"} 訂單</h1>
      <EntityForm
        schema={createOrderSchema}
        defaultValues={defaultValues}
        fields={fieldConfigs}
        onSubmit={handleSubmit}
        loading={saving}
        submitLabel={isEdit ? "Update" : "Create"}
        onCancel={() => navigate({ to: "/orders" })}
      >
        <InlineDetailTable
          title="訂單明細"
          items={orderItemItems}
          onItemsChange={setOrderItemItems}
          columns={orderItemColumns}
          fieldConfigs={orderItemFieldConfigs}
          schema={createOrderItemItemSchema}
          defaultValues={orderItemDefaults}
        />
      </EntityForm>
    </div>
  );
}

