// Auto-generated by XekuII.Generator - DO NOT EDIT
// Generated at: 2026-02-06 22:03:33

import { useQuery, useQueryClient } from "@tanstack/react-query";
import { useNavigate, useParams } from "@tanstack/react-router";
import { useState, useEffect } from "react";
import { purchaseOrderApi } from "../../api/purchase-order.api.generated";
import { createPurchaseOrderSchema } from "../../schemas/purchase-order.schema.generated";
import type { CreatePurchaseOrderDto } from "../../types/purchase-order.types.generated";
import type { CreatePurchaseOrderItemItemDto } from "../../types/purchase-order.types.generated";
import { createPurchaseOrderItemItemSchema } from "../../schemas/purchase-order.schema.generated";
import { InlineDetailTable, type InlineDetailItem, type InlineDetailColumn } from "@/components/shared/InlineDetailTable";
import { PurchaseStatus, PurchaseStatusLabels } from "../../types/purchase-order.types.generated";
import { EntityForm, type FieldConfig, type FormRowConfig } from "@/components/shared/EntityForm";
import { ReferenceSelect } from "@/components/shared/ReferenceSelect";
import { PageLoading } from "@/components/shared/LoadingSpinner";
import { toast } from "sonner";
import { useEntityPermissions } from "@/hooks/usePermissions";
import { Input } from "@/components/ui/input";

const fieldConfigs: FieldConfig[] = [
  { name: "poNumber", label: "採購單號", type: "text" as const },
  { name: "orderDate", label: "採購日期", type: "date" as const },
  {
    name: "status",
    label: "狀態",
    type: "custom" as const,
    render: ({ value, onChange }) => (
      <select
        className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
        value={String(value ?? "")}
        onChange={(e) => onChange(e.target.value)}
      >
        <option value="">Select...</option>
        {Object.entries(PurchaseStatusLabels).map(([k, v]) => (
          <option key={k} value={k}>{v}</option>
        ))}
      </select>
    ),
  },
  {
    name: "supplierId",
    label: "供應商",
    type: "custom" as const,
    render: ({ value, onChange }) => (
      <ReferenceSelect
        endpoint="/suppliers"
        value={value as string | null}
        onChange={onChange as (v: string | null) => void}
        labelField="name"
        placeholder="Select 供應商..."
      />
    ),
  },
];

const formLayout: FormRowConfig[] = [
  { fields: ["poNumber", "orderDate"] },
  { fields: ["supplierId", "status"] },
];

const purchaseOrderItemFieldConfigs: FieldConfig[] = [
  { 
    name: "quantity", 
    label: "數量", 
    type: "number" as const,
    render: ({ value, onChange }, { setValue, getValues }) => (
      <Input 
        type="number" 
        value={value as number || 0} 
        onChange={(e) => {
          const newVal = e.target.valueAsNumber || 0;
          onChange(newVal);
          const otherVal = Number(getValues("unitPrice")) || 0;
          setValue("subtotal", newVal * otherVal, { shouldValidate: true, shouldDirty: true });
        }}
        placeholder="數量"
      />
    ),
  },
  { 
    name: "unitPrice", 
    label: "進貨單價", 
    type: "number" as const,
    render: ({ value, onChange }, { setValue, getValues }) => (
      <Input 
        type="number" 
        value={value as number || 0} 
        onChange={(e) => {
          const newVal = e.target.valueAsNumber || 0;
          onChange(newVal);
          const otherVal = Number(getValues("quantity")) || 0;
          setValue("subtotal", newVal * otherVal, { shouldValidate: true, shouldDirty: true });
        }}
        placeholder="進貨單價"
      />
    ),
  },
  { 
    name: "subtotal", 
    label: "小計", 
    type: "custom" as const,
    render: ({ value }) => <div className="py-2 px-3 bg-muted rounded-md font-medium text-right">{(Number(value) || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
  },
  {
    name: "productId",
    label: "採購產品",
    type: "custom" as const,
    render: ({ value, onChange }, { setValue }) => (
      <ReferenceSelect
        endpoint="/products"
        value={value as string | null}
        onChange={onChange as (v: string | null) => void}
        onLabelChange={(label) => setValue("productName", label, { shouldValidate: true, shouldDirty: true })}
        labelField="name"
        placeholder="Select 採購產品..."
      />
    ),
  },
];

const purchaseOrderItemColumns: InlineDetailColumn[] = [
  { key: "quantity", header: "數量" },
  { key: "unitPrice", header: "進貨單價" },
  { key: "subtotal", header: "小計" },
  { key: "productName", header: "採購產品" },
];

const purchaseOrderItemDefaults: Record<string, unknown> = {
  quantity: 1,
  unitPrice: 0,
  subtotal: 0,
  productId: null,
  productName: null,
};

export function PurchaseOrderFormPage() {
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const params = useParams({ strict: false });
  const id = (params as Record<string, string | undefined>).id;
  const isEdit = !!id;
  const { canCreate, canUpdate, loaded: permissionsLoaded } = useEntityPermissions("PurchaseOrder");
  const [saving, setSaving] = useState(false);

  const [purchaseOrderItemItems, setPurchaseOrderItemItems] = useState<InlineDetailItem[]>([]);
  const [detailsLoaded, setDetailsLoaded] = useState(false);

  const { data: existing, isLoading } = useQuery({
    queryKey: ["purchaseOrder", id],
    queryFn: () => purchaseOrderApi.getById(id!),
    enabled: isEdit,
  });

  useEffect(() => {
    if (!isEdit || !id || detailsLoaded) return;
    purchaseOrderApi.getDetails(id).then((data) => {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const d = data as any;
      setPurchaseOrderItemItems((d.items || []).map((item: any) => ({
        ...item,
        _localId: crypto.randomUUID(),
        _status: "existing" as const,
        _serverId: item.oid ?? item.id,
      })));
      setDetailsLoaded(true);
    });
  }, [isEdit, id, detailsLoaded]);

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  async function handleSubmit(masterData: any) {
    setSaving(true);
    try {
      let masterId: string;
      if (isEdit) {
        await purchaseOrderApi.update(id!, masterData as CreatePurchaseOrderDto);
        masterId = id!;
      } else {
        const result = await purchaseOrderApi.create(masterData as CreatePurchaseOrderDto);
        masterId = result.oid;
      }

      const failures: string[] = [];
      for (const item of purchaseOrderItemItems.filter(i => i._status === "deleted" && i._serverId)) {
        try { await purchaseOrderApi.deletePurchaseOrderItem(masterId, item._serverId!); }
        catch { failures.push(`Delete 採購明細 ${item._serverId}`); }
      }
      for (const item of purchaseOrderItemItems.filter(i => i._status === "modified" && i._serverId)) {
        try {
          const dto = { ...item } as any;
          delete dto._localId; delete dto._status; delete dto._serverId; delete dto.id;
          await purchaseOrderApi.updatePurchaseOrderItem(masterId, item._serverId!, dto);
        } catch { failures.push(`Update 採購明細`); }
      }
      for (const item of purchaseOrderItemItems.filter(i => i._status === "new")) {
        try {
          const dto = { ...item } as any;
          delete dto._localId; delete dto._status; delete dto._serverId;
          await purchaseOrderApi.addPurchaseOrderItem(masterId, dto as CreatePurchaseOrderItemItemDto);
        } catch { failures.push(`Add 採購明細`); }
      }
      queryClient.invalidateQueries({ queryKey: ["purchaseOrders"] });
      queryClient.invalidateQueries({ queryKey: ["purchaseOrder", masterId] });

      if (failures.length > 0) {
        toast.warning(`採購單 saved, but ${failures.length} detail items failed`);
        navigate({ to: "/purchase-orders/$id", params: { id: masterId } });
      } else {
        toast.success(isEdit ? "採購單 updated" : "採購單 created");
        navigate({ to: "/purchase-orders" });
      }
    } catch {
      toast.error("Failed to save 採購單");
    } finally {
      setSaving(false);
    }
  }

  useEffect(() => {
    if (!permissionsLoaded) return;
    if ((!isEdit && !canCreate) || (isEdit && !canUpdate)) {
      toast.error("You don't have permission to perform this action");
      navigate({ to: "/purchase-orders" });
    }
  }, [isEdit, canCreate, canUpdate, permissionsLoaded, navigate]);

  if (isEdit && isLoading) return <PageLoading />;

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const ex = existing as any;
  const defaultValues = isEdit && ex
    ? {
      poNumber: ex.poNumber ?? "NEW",
      orderDate: ex.orderDate ?? new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16),
      status: ex.status ?? PurchaseStatus.Draft,
      supplierId: ex.supplierId ?? null,
    }
    : {
      poNumber: "NEW",
      orderDate: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16),
      status: PurchaseStatus.Draft,
      supplierId: null,
    };

  return (
    <div className="max-w-5xl space-y-4">
      <h1 className="text-2xl font-bold">{isEdit ? "Edit" : "New"} 採購單</h1>
      <EntityForm
        schema={createPurchaseOrderSchema}
        defaultValues={defaultValues}
        fields={fieldConfigs}
        layout={formLayout}
        onSubmit={handleSubmit}
        loading={saving}
        submitLabel={isEdit ? "Update" : "Create"}
        onCancel={() => navigate({ to: "/purchase-orders" })}
      >
        <InlineDetailTable
          title="採購明細"
          items={purchaseOrderItemItems}
          onItemsChange={setPurchaseOrderItemItems}
          columns={purchaseOrderItemColumns}
          fieldConfigs={purchaseOrderItemFieldConfigs}
          schema={createPurchaseOrderItemItemSchema}
          defaultValues={purchaseOrderItemDefaults}
        />
      </EntityForm>
    </div>
  );
}

